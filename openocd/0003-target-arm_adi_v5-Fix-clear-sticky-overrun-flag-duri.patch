From ced7458098ecc8b03a1d73bcbdae7f5d503146ea Mon Sep 17 00:00:00 2001
From: micbis <michele.bisogno.ct@renesas.com>
Date: Wed, 26 May 2021 19:11:05 +0200
Subject: [PATCH 3/3] target/arm_adi_v5: Fix clear sticky overrun flag during
 replay of commands

When a WAIT occurs the commands after the WAIT are replayed and the
STICKYORUN is cleared. However if another WAIT occurs during the
command replay, the command itself is resent but the STICKYORUN bit
shall also be cleared. If this is not done, the MEM-AP hangs.

Change-Id: I14e8340cd5d8f58f4de31509da96cfa2ecb630d1
Signed-off-by: micbis <michele.bisogno.ct@renesas.com>
---
 src/target/adi_v5_jtag.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/target/adi_v5_jtag.c b/src/target/adi_v5_jtag.c
index 6dede972c..239253d20 100644
--- a/src/target/adi_v5_jtag.c
+++ b/src/target/adi_v5_jtag.c
@@ -574,6 +574,13 @@ static int jtagdp_overrun_check(struct adiv5_dap *dap)
 					retval = ERROR_JTAG_DEVICE_ERROR;
 					break;
 				}
+				LOG_INFO("DAP transaction stalled during replay (WAIT) - resending");
+				/* clear the sticky overrun condition */
+				retval = adi_jtag_scan_inout_check_u32(dap, JTAG_DP_DPACC,
+						DP_CTRL_STAT, DPAP_WRITE,
+						dap->dp_ctrl_stat | SSTICKYORUN, NULL, 0);
+				if (retval != ERROR_OK)
+					break;
 			} while (timeval_ms() - time_now < 1000);
 
 			if (retval == ERROR_OK) {
-- 
2.25.1

